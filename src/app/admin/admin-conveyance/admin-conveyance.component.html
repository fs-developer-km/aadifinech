<div class="admin-conveyance-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-tasks"></i>
        Admin - Conveyance Management
      </h1>
      <button class="btn-refresh" (click)="refreshData()">
        <i class="fas fa-sync-alt" [class.spinning]="loading"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Statistics Dashboard -->
  <div class="stats-section">
    <h2 class="section-title">
      <i class="fas fa-chart-bar"></i> Statistics Overview
    </h2>
    
    <div class="stats-grid" *ngIf="statistics">
      <!-- Total Conveyances -->
      <div class="stat-card blue">
        <div class="stat-icon">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="stat-content">
          <!-- <h3>{{ statistics.overall?.totalConveyances || 0 }}</h3> -->
          <h3>{{ statistics.overall.totalConveyances || 0 }}</h3>

          <p>Total Conveyances</p>
        </div>
      </div>

      <!-- Total Amount -->
      <div class="stat-card green">
        <div class="stat-icon">
          <i class="fas fa-rupee-sign"></i>
        </div>
        <div class="stat-content">
          <h3>₹{{ statistics.overall.totalAmount || 0 | number:'1.0-0' }}</h3>
          <p>Total Amount</p>
        </div>
      </div>

      <!-- Total Distance -->
      <div class="stat-card orange">
        <div class="stat-icon">
          <i class="fas fa-road"></i>
        </div>
        <div class="stat-content">
          <h3>{{ statistics.overall.totalDistance || 0 | number:'1.0-0' }} km</h3>
          <p>Total Distance</p>
        </div>
      </div>

      <!-- Pending Approvals -->
      <div class="stat-card red">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getPendingCount() }}</h3>
          <p>Pending Approvals</p>
        </div>
      </div>
    </div>

    <!-- Status Breakdown -->
    <div class="status-breakdown" *ngIf="statistics && statistics.byStatus">
      <h3>Status Breakdown</h3>
      <div class="breakdown-grid">
        <div class="breakdown-card" *ngFor="let status of statistics.byStatus">
          <div class="breakdown-header">
            <span class="status-badge" [ngClass]="status._id">{{ status._id | uppercase }}</span>
            <span class="count-badge">{{ status.count }}</span>
          </div>
          <div class="breakdown-details">
            <div class="detail-item">
              <span class="label">Amount:</span>
              <span class="value">₹{{ status.totalAmount | number:'1.0-0' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Distance:</span>
              <span class="value">{{ status.totalDistance | number:'1.0-0' }} km</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-header">
      <h3><i class="fas fa-filter"></i> Filters</h3>
      <button class="btn-clear" (click)="clearFilters()">
        <i class="fas fa-times"></i> Clear All
      </button>
    </div>

    <div class="filters-grid">
      <div class="filter-group">
        <label>Month & Year</label>
        <input type="month" [(ngModel)]="filters.month" (change)="loadConveyances()" class="form-control">
      </div>

      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="filters.status" (change)="loadConveyances()" class="form-control">
          <option value="">All Status</option>
          <option value="draft">Draft</option>
          <option value="submitted">Submitted</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="paid">Paid</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Employee ID</label>
        <input type="text" [(ngModel)]="filters.employeeId" (change)="loadConveyances()" 
               placeholder="Enter employee ID" class="form-control">
      </div>

      <div class="filter-group">
        <label>Employee Name</label>
        <input type="text" [(ngModel)]="filters.employeeName" (change)="filterByName()" 
               placeholder="Search by name" class="form-control">
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading conveyances...</p>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && filteredConveyances.length === 0">
    <i class="fas fa-inbox"></i>
    <h3>No Conveyances Found</h3>
    <p>No conveyances match the selected filters</p>
  </div>

  <!-- Conveyances Table -->
  <div class="table-section" *ngIf="!loading && filteredConveyances.length > 0">
    <div class="table-header">
      <h3>
        <i class="fas fa-list"></i> 
        Conveyances List ({{ filteredConveyances.length }})
      </h3>
      <div class="view-toggle">
        <button [class.active]="viewMode === 'card'" (click)="viewMode = 'card'">
          <i class="fas fa-th-large"></i> Card View
        </button>
        <button [class.active]="viewMode === 'table'" (click)="viewMode = 'table'">
          <i class="fas fa-table"></i> Table View
        </button>
      </div>
    </div>

    <!-- Card View -->
    <div class="conveyances-grid" *ngIf="viewMode === 'card'">
      <div class="conveyance-card" *ngFor="let conveyance of filteredConveyances">
        <!-- Card Header -->
        <div class="card-header">
          <div class="employee-info">
            <div class="employee-avatar">
              <i class="fas fa-user"></i>
            </div>
            <div class="employee-details">
              <h4>{{ conveyance.employeeName }}</h4>
              <p><i class="fas fa-phone"></i> {{ conveyance.employeeMobile }}</p>
            </div>
          </div>
          <span class="status-badge" [ngClass]="conveyance.status">
            {{ conveyance.status | uppercase }}
          </span>
        </div>

        <!-- Card Body -->
        <div class="card-body">
          <div class="info-row">
            <div class="info-item">
              <i class="fas fa-calendar"></i>
              <span>{{ conveyance.month | date:'MMMM yyyy' }}</span>
            </div>
            <div class="info-item">
              <i class="fas fa-list-ol"></i>
              <span>{{ conveyance.entries ? conveyance.entries.length : 0 }} Entries</span>
            </div>
          </div>

          <div class="summary-row">
            <div class="summary-box">
              <i class="fas fa-road"></i>
              <div>
                <span class="label">Distance</span>
                <span class="value">{{ conveyance.totalDistance }} km</span>
              </div>
            </div>
            <div class="summary-box">
              <i class="fas fa-rupee-sign"></i>
              <div>
                <span class="label">Amount</span>
                <span class="value">₹{{ conveyance.totalAmount }}</span>
              </div>
            </div>
          </div>

          <!-- Submission Details -->
          <div class="submission-details" *ngIf="conveyance.submittedAt">
            <i class="fas fa-clock"></i>
            <span>Submitted: {{ conveyance.submittedAt | date:'dd/MM/yyyy hh:mm a' }}</span>
          </div>

          <!-- Remarks -->
          <div class="remarks-box" *ngIf="conveyance.adminRemarks">
            <strong><i class="fas fa-comment"></i> Remarks:</strong>
            <p>{{ conveyance.adminRemarks }}</p>
          </div>
          <div class="remarks-box rejection" *ngIf="conveyance.rejectionReason">
            <strong><i class="fas fa-exclamation-circle"></i> Rejection:</strong>
            <p>{{ conveyance.rejectionReason }}</p>
          </div>
        </div>

        <!-- Card Footer (Actions) -->
        <div class="card-footer">
          <button class="btn-view" (click)="viewDetails(conveyance)">
            <i class="fas fa-eye"></i> View Details
          </button>

          <div class="action-buttons" *ngIf="conveyance.status === 'submitted'">
            <button class="btn-approve" (click)="openApproveModal(conveyance)">
              <i class="fas fa-check"></i> Approve
            </button>
            <button class="btn-reject" (click)="openRejectModal(conveyance)">
              <i class="fas fa-times"></i> Reject
            </button>
          </div>

          <button class="btn-paid" *ngIf="conveyance.status === 'approved'" 
                  (click)="markAsPaid(conveyance._id)">
            <i class="fas fa-money-bill"></i> Mark Paid
          </button>
        </div>
      </div>
    </div>

    <!-- Table View -->
    <div class="table-wrapper" *ngIf="viewMode === 'table'">
      <table class="data-table">
        <thead>
          <tr>
            <th>Employee</th>
            <th>Month</th>
            <th>Entries</th>
            <th>Distance</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let conveyance of filteredConveyances">
            <td>
              <div class="employee-cell">
                <strong>{{ conveyance.employeeName }}</strong>
                <small>{{ conveyance.employeeMobile }}</small>
              </div>
            </td>
            <td>{{ conveyance.month | date:'MMM yyyy' }}</td>
            <td class="center">{{ conveyance.entries ? conveyance.entries.length : 0 }}</td>
            <td>{{ conveyance.totalDistance }} km</td>
            <td class="amount">₹{{ conveyance.totalAmount }}</td>
            <td>
              <span class="status-badge" [ngClass]="conveyance.status">
                {{ conveyance.status }}
              </span>
            </td>
            <td>
              <small *ngIf="conveyance.submittedAt">
                {{ conveyance.submittedAt | date:'dd/MM/yy' }}
              </small>
              <span *ngIf="!conveyance.submittedAt">-</span>
            </td>
            <td>
              <div class="table-actions">
                <button class="btn-icon" (click)="viewDetails(conveyance)" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-icon success" *ngIf="conveyance.status === 'submitted'" 
                        (click)="openApproveModal(conveyance)" title="Approve">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-icon danger" *ngIf="conveyance.status === 'submitted'" 
                        (click)="openRejectModal(conveyance)" title="Reject">
                  <i class="fas fa-times"></i>
                </button>
                <button class="btn-icon info" *ngIf="conveyance.status === 'approved'" 
                        (click)="markAsPaid(conveyance._id)" title="Mark Paid">
                  <i class="fas fa-money-bill"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><i class="fas fa-file-invoice"></i> Conveyance Details</h2>
      <button class="close-btn" (click)="closeDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedConveyance">
      <!-- Employee Info -->
      <div class="detail-section">
        <h3>Employee Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="label">Name:</span>
            <span class="value">{{ selectedConveyance.employeeName }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Mobile:</span>
            <span class="value">{{ selectedConveyance.employeeMobile }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Employee ID:</span>
            <span class="value">{{ selectedConveyance.employeeId }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Status:</span>
            <span class="status-badge" [ngClass]="selectedConveyance.status">
              {{ selectedConveyance.status | uppercase }}
            </span>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="detail-section">
        <h3>Summary</h3>
        <div class="summary-cards">
          <div class="summary-card">
            <i class="fas fa-calendar"></i>
            <div>
              <span class="label">Period</span>
              <span class="value">{{ selectedConveyance.month | date:'MMMM yyyy' }}</span>
            </div>
          </div>
          <div class="summary-card">
            <i class="fas fa-list"></i>
            <div>
              <span class="label">Total Entries</span>
              <span class="value">{{ selectedConveyance.entries ? selectedConveyance.entries.length : 0 }}</span>
            </div>
          </div>
          <div class="summary-card">
            <i class="fas fa-road"></i>
            <div>
              <span class="label">Total Distance</span>
              <span class="value">{{ selectedConveyance.totalDistance }} km</span>
            </div>
          </div>
          <div class="summary-card">
            <i class="fas fa-rupee-sign"></i>
            <div>
              <span class="label">Total Amount</span>
              <span class="value">₹{{ selectedConveyance.totalAmount }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Travel Entries -->
      <div class="detail-section">
        <h3>Travel Entries</h3>
        <div class="entries-list">
          <div class="entry-item" *ngFor="let entry of selectedConveyance.entries; let i = index">
            <div class="entry-number">{{ i + 1 }}</div>
            <div class="entry-content">
              <div class="entry-row">
                <div class="entry-field">
                  <span class="field-label">Date:</span>
                  <span class="field-value">{{ entry.date | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="entry-field">
                  <span class="field-label">Mode:</span>
                  <span class="mode-badge">{{ entry.mode }}</span>
                </div>
              </div>
              <div class="entry-row">
                <div class="entry-field full">
                  <span class="field-label">Route:</span>
                  <span class="field-value">
                    {{ entry.fromLocation }} <i class="fas fa-arrow-right"></i> {{ entry.toLocation }}
                  </span>
                </div>
              </div>
              <div class="entry-row">
                <div class="entry-field">
                  <span class="field-label">Distance:</span>
                  <span class="field-value">{{ entry.distance }} km</span>
                </div>
                <div class="entry-field">
                  <span class="field-label">Amount:</span>
                  <span class="field-value amount">₹{{ entry.amount }}</span>
                </div>
              </div>
              <div class="entry-row">
                <div class="entry-field full">
                  <span class="field-label">Purpose:</span>
                  <span class="field-value">{{ entry.purpose }}</span>
                </div>
              </div>
              <div class="entry-row" *ngIf="entry.remarks">
                <div class="entry-field full">
                  <span class="field-label">Remarks:</span>
                  <span class="field-value">{{ entry.remarks }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Remarks Section -->
      <div class="detail-section" *ngIf="selectedConveyance.adminRemarks || selectedConveyance.rejectionReason">
        <h3>Admin Remarks</h3>
        <div class="remarks-detail" *ngIf="selectedConveyance.adminRemarks">
          <p>{{ selectedConveyance.adminRemarks }}</p>
        </div>
        <div class="remarks-detail rejection" *ngIf="selectedConveyance.rejectionReason">
          <strong>Rejection Reason:</strong>
          <p>{{ selectedConveyance.rejectionReason }}</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeDetailsModal()">Close</button>
      <button class="btn-approve" *ngIf="selectedConveyance && selectedConveyance.status === 'submitted'" 
              (click)="closeDetailsModal(); openApproveModal(selectedConveyance)">
        <i class="fas fa-check"></i> Approve
      </button>
      <button class="btn-reject" *ngIf="selectedConveyance && selectedConveyance.status === 'submitted'" 
              (click)="closeDetailsModal(); openRejectModal(selectedConveyance)">
        <i class="fas fa-times"></i> Reject
      </button>
    </div>
  </div>
</div>

<!-- Approve Modal -->
<div class="modal-overlay" *ngIf="showApproveModal" (click)="closeApproveModal()">
  <div class="modal-content small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><i class="fas fa-check-circle"></i> Approve Conveyance</h2>
      <button class="close-btn" (click)="closeApproveModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="approval-info" *ngIf="selectedConveyance">
        <p><strong>Employee:</strong> {{ selectedConveyance.employeeName }}</p>
        <p><strong>Amount:</strong> ₹{{ selectedConveyance.totalAmount }}</p>
        <p><strong>Distance:</strong> {{ selectedConveyance.totalDistance }} km</p>
      </div>

      <div class="form-group">
        <label>Admin Remarks (Optional)</label>
        <textarea [(ngModel)]="approveRemarks" class="form-control" rows="4" 
                  placeholder="Add any remarks for approval..."></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeApproveModal()">Cancel</button>
      <button class="btn-approve" (click)="approveConveyance()" [disabled]="saving">
        <i class="fas" [ngClass]="saving ? 'fa-spinner fa-spin' : 'fa-check'"></i>
        {{ saving ? 'Approving...' : 'Approve' }}
      </button>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div class="modal-overlay" *ngIf="showRejectModal" (click)="closeRejectModal()">
  <div class="modal-content small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><i class="fas fa-times-circle"></i> Reject Conveyance</h2>
      <button class="close-btn" (click)="closeRejectModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="rejection-info" *ngIf="selectedConveyance">
        <p><strong>Employee:</strong> {{ selectedConveyance.employeeName }}</p>
        <p><strong>Amount:</strong> ₹{{ selectedConveyance.totalAmount }}</p>
      </div>

      <div class="form-group">
        <label>Rejection Reason *</label>
        <textarea [(ngModel)]="rejectReason" class="form-control" rows="4" 
                  placeholder="Please provide a clear reason for rejection..." required></textarea>
        <small class="helper-text">This will be visible to the employee</small>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeRejectModal()">Cancel</button>
      <button class="btn-reject" (click)="rejectConveyance()" 
              [disabled]="saving || !rejectReason || rejectReason.trim().length === 0">
        <i class="fas" [ngClass]="saving ? 'fa-spinner fa-spin' : 'fa-times'"></i>
        {{ saving ? 'Rejecting...' : 'Reject' }}
      </button>
    </div>
  </div>
</div>